# GoFrame Template For SingleRepo

Quick Start: 
- https://goframe.org/pages/viewpage.action?pageId=1114399


# anime-petition-service
动漫请愿的后端服务

## 项目介绍
该平台为动漫众筹请愿平台，根据动漫人物发行NFT，针对NFT的铸造限时限量对用户开放。用户也可以直接在平台购买NFT进行珍藏和创作请愿。平台方会奖NFT售价的80%支付给创作者进行创作，并且购买NFT的用户可以将自己期望的动漫剧情反馈到平台，平台方会联系作者进行合作。
为了保证众筹的资金安全并在指定时间内作者完成作品后才允许提现NFT的售价，平台方会对每笔NFT购买的交易进行锁仓，锁仓期由平台方、NFT的持有者、作家共同决定
NFT的二次交易存在一定的版税，版税的百分比由平台方决定，最高不超过15%

## 用户点击购买NFT，发起请愿
用户点击购买NFT按钮，前端直接与合约进行交互，每个NFT的售价在发布合约时进行设定，用户支付的金额需要大于等于NFT的售价，合约会将用户的钱包地址和NFT的id绑定，用户可以随时查看自己的NFT的状态。每购买1个NFT等于1次请愿，用户可以发起多个请愿。
购买成功后请求后端提供的 /user/create_petition 接口服务 （可暂不实现）
```
GET /user/create_petition?username=xxx&tx_id=xxxx&nft_id=xxx&nft_num=100&token=xxxxx
```
username: 用户钱包地址
token: 用户登录后后端返回的token
nft_id: 购买的NFT的id
nft_num: 购买的NFT的数量
tx_id: 本次交易返回的交易hash

```
200 OK

{"status": 200, "message": "create petition success", "data": {"token": "xxxxx"}}
```
token：用户登录后获取的token

```
401 Unauthorized
{"status": 401, "message": "buy token failed, signature error"}
```

## 用户登录
```
POST /user/login

{"message":{"domain":"127.0.0.1","address":"0xd92E778D3E40c9E4E42411f847c76650Dd4f27fC","chainId":59144,"nonce":"69694253","timestamp":"1731825448","statement":"Sign in to Anime Petition", "type": "login"},"signature":"0xace0bd76c944d48155a34b764617e5d4c68afe04b08b424d55ca9ad37d614cac7d23253f1d03dca3610dddc7d146c6e1fdb64750f076b59f1ada96b392774dd21b"}
```

signature: Signature of the request parameters, generated by the user's private key, the original data of the signature is domain + address address + "login" (eg: 591440xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266login)
59144 是Linea链的ID

```
200 OK

{"code":0,"message":"","data":{"message":"login success","token":"3a00f83e-0fec-4d50-92bd-8441363929bf"}}
```
code: 0 表示成功,其他失败
token：用户登录后获取的token

失败场景
```
200 OK

{"code":50,"message":"Failed to verify message","data":null}
```

### debug
curl -v -l -H "Content-type: application/json" -X POST -d '{"message":{"domain":"127.0.0.1","address":"0x5639Bc2D96c7bA37EECA625599B183241A2bBE6c","chainId":"59144","nonce":"69694253","timestamp":"1731825448","statement":"Sign in to Anime Petition", "type": "login"},"signature":"0xc43b720062b2db3b20204ddb07ecdfc384e7814d31b7351256f4261c7d311eec7588aaa708ae5cc80e9c024b9ace24b522f9f90e6675e0455fc1c96c6efa37e51c"}' http://127.0.0.1:8000/user/login

ethereum.enable()
account = "0x5639Bc2D96c7bA37EECA625599B183241A2bBE6c"
message = "127.0.0.10x5639Bc2D96c7bA37EECA625599B183241A2bBE6cSign in to Anime Petitionlogin59144696942531731825448"
ethereum.request({method: "personal_sign", params: [account, message]})
0xc43b720062b2db3b20204ddb07ecdfc384e7814d31b7351256f4261c7d311eec7588aaa708ae5cc80e9c024b9ace24b522f9f90e6675e0455fc1c96c6efa37e51c

## 用户注销
```
POST /user/logout

{"user": "xxx", "token": "xxxxx"}
```

```
200 OK

{"code":0,"message":"","data":{"message":"logout success"}}
```
code: 0 表示成功,其他失败

## 当前登录动漫请愿的用户活跃度
```
GET /user/active_users_info
```

```
200 OK

{"code":0,"message":"","data":{"message":"get active user info success","total_users":1}}
```
code: 0 表示成功,其他失败
total_users：当前登录过动漫请愿的用户数量

## 以下数据，前端直接调用合约的接口获取
petition_nums：当前请愿次数，表示用户发起的请愿数量总量
某个nft 的 petition_nums：当前该NFT的请愿次数